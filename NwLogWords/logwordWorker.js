importScripts("https://cdnjs.cloudflare.com/ajax/libs/lokijs/1.4.1/lokijs.min.js");importScripts("https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js");importScripts("../NwLib/NwSS.min.js");var db=new loki("test",{env:"BROWSER"});var words=db.addCollection("datas");words.ensureIndex("esearch",true);self.addEventListener("message",function(e){if(e.data.msg=="insertWordsRow"){var code=e.data.c;var data=NwSS.SS.dct(e.data.data,code).toString(NwSS.enc.Utf8);var dataSp=data.split("\r\n");var obj=_.map(dataSp,function(word){return{esearch:word}});words.insert(obj);self.postMessage(e.data)}else if(e.data.msg=="findWord"){var text=e.data.data;var reg=new RegExp("^"+text,"i");var query={esearch:{$regex:reg}};var docs=words.chain().find(query).simplesort("esearch").limit(15).data();if(docs.length!=0){var foundWord=_.findWhere(docs,{esearch:text});if(!foundWord){var doc=words.findOne({esearch:text});if(doc){docs.unshift(doc)}}else{for(var i in docs){if(docs[i].esearch==text){docs[i]=false;break}}docs=_.compact(docs);docs.unshift(foundWord)}}e.data.data={esearch:text,docs:docs};self.postMessage(e.data)}},false);